#!/usr/bin/env python
# coding: utf-8

"""
Find the output of (most) tasks.
"""

from __future__ import print_function
from gluish.utils import pairwise
from luigi.task import Register
from siskin.sources.b3kat import *
from siskin.sources.bms import *
from siskin.sources.bnf import *
from siskin.sources.bsz import *
from siskin.sources.bvb import *
from siskin.sources.disson import *
from siskin.sources.doab import *
from siskin.sources.doaj import *
from siskin.sources.ebl import *
from siskin.sources.ebrary import *
from siskin.sources.elsevier import *
from siskin.sources.ema import *
from siskin.sources.freebase import *
from siskin.sources.gbv import *
from siskin.sources.gnd import *
from siskin.sources.gutenberg import *
from siskin.sources.hathi import *
from siskin.sources.hszigr import *
from siskin.sources.imslp import *
from siskin.sources.imdb import *
from siskin.sources.ksd import *
from siskin.sources.liberec import *
from siskin.sources.lfer import *
from siskin.sources.mor import *
from siskin.sources.mtc import *
from siskin.sources.munz import *
from siskin.sources.naxos import *
from siskin.sources.nep import *
from siskin.sources.nl import *
from siskin.sources.opiv import *
from siskin.sources.oso import *
from siskin.sources.pao import *
from siskin.sources.pilsen import *
from siskin.sources.pqdtopen import *
from siskin.sources.qucosa import *
from siskin.sources.rism import *
from siskin.sources.ssoar import *
from siskin.sources.swbod import *
from siskin.sources.viaf import *
from siskin.sources.vifa import *
from siskin.sources.wikidata import *
from siskin.sources.wikipedia import *
from siskin.sources.yago import *
from siskin.workflows.daily import *
from siskin.workflows.fuzzy import *
import collections
import luigi
import sys


if __name__ == '__main__':
    if len(sys.argv) < 2:
        print('taskoutput TASKNAME', file=sys.stderr)
        sys.exit(1)

    taskname = sys.argv[1]
    if not taskname in locals():
        print('no such task: %s' % taskname, file=sys.stderr)
        sys.exit(1)

    kwargs = dict((k.lstrip('--').replace('-', '_'), v)
                   for k, v in pairwise(sys.argv[2:]))

    # ignore global arguments
    for param in ('local-scheduler', 'lock', 'lock-pid-dir',
                  'logging-conf-file', 'scheduler-host', 'scheduler-port',
                  'workers'):
        kwargs.pop(param, None)

    task_klass = Register.get_reg().get(taskname)
    typed_kwargs = dict()
    for k, v in kwargs.iteritems():
        try:
            klass = getattr(task_klass, k).__class__
            typed_kwargs[k] = klass().parse(v)
        except AttributeError as err:
            print('ignoring missed attribute %s'.format(k))

    task = locals()[taskname](**typed_kwargs)
    output = task.output()

    if isinstance(output, collections.Iterable):
        if isinstance(output, dict):
            for key, target in output.iteritems():
                print(target.fn, file=sys.stdout)
        else:
            for op in output:
                try:
                    print(op.path, file=sys.stdout)
                except AttributeError:
                    print(op, file=sys.stdout)
    else:
        print(output.path, file=sys.stdout)
